---
title: "Midterm"
author: "Brendan Cullen"
date: "4/22/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(purrr)
library(glue)
library(rio)
library(janitor)
library(colorblindr)
```

# Part A: Data

```{r}
# define function to download data  
download_file <- function(year) {
    link <- glue::glue("https://www.oregon.gov/ode/educator-resources/assessment/TestResults20{year}/pagr_schools_ela_raceethnicity_{year-1}{year}.xlsx")
    rio::import(link, setclass = "tibble", na = c("-", "--", "*"))
}
```

## Question 1

```{r cache=TRUE}
# download all the data from the past 4 years
data <- map_df(15:18, download_file) 

# wrangle data
data <- data %>% 
  clean_names() %>% 
  filter(student_group %in% c("White", "Hispanic/Latino")) %>% 
  gather(c(number_level_1, number_level_2, number_level_3, number_level_4), key = level, value = n) %>%
  mutate(level = recode(level, 
                        "number_level_1" = 1, 
                        "number_level_2" = 2, 
                        "number_level_3" = 3, 
                        "number_level_4" = 4)) %>% 
  select(academic_year, district, school, student_group, grade_level, level, n) %>% 
  drop_na(n)
```

## Question 2

```{r}
#  Calculate the cumulative n for each school by student group, grade, and academic year.
data_cn <- split(data, list(data$school, 
                            data$academic_year, 
                            data$student_group, 
                            data$grade_level), drop = TRUE) %>% 
          map_df(~mutate(.x, cn = cumsum(n)))

data_cn
```

## Question 3

```{r}
# Reformat the data 
data_cn <- data_cn %>% 
  select(-n) %>% 
  spread(student_group, cn) %>% 
  clean_names() %>% 
  drop_na(c(hispanic_latino, white))

data_cn
```

# Part B: Achievement gaps

```{r}
# define funtion for later use
gap <- function(data, ref, foc) {
    x <- data[[ref]]
    y <- data[[foc]]
    auc <- pracma::trapz(y / y[length(x)],
                         x / x[length(x)])
    sqrt(2)*qnorm(auc)
}
```

## Question 1

```{r}
# Estimate an achievement gap effect size for every school in the state that reported data on both student groups (i.e., using the data we created above), for each grade level in each academic year.
data_es <- data_cn %>% 
  group_by(school, grade_level, academic_year) %>%
  nest() %>% 
  mutate(es = map_dbl(data, ~gap(.x, ref = "white", foc = "hispanic_latino")))
```

## Question 2

```{r}
# Wrangle data for plots
plot_data_split <- data_es %>% 
  select(-c(level, hispanic_latino, white)) %>% 
  distinct() %>% 
  mutate(grade_level = as.factor(recode(grade_level, 
                        "Grade 3" = 3, 
                        "Grade 4" = 4,
                        "Grade 5" = 5,
                        "Grade 6" = 6,
                        "Grade 7" = 7,
                        "Grade 8" = 8,
                        "Grade HS (11)" = 11))) %>% 
  split(list(.$academic_year, .$school))

# Create plots 
plot_data_split[["2017-2018.Ashland Middle School"]] %>% 
  ggplot(aes(grade_level, es, fill = es)) +
  geom_col(alpha = 0.7) + 
  coord_flip() + 
  theme_minimal() +
  labs(x = "Grade", 
       y = "Effect Size", 
       #title = paste("Achievement Gap Estimates:", .$school[1]) +
       subtitle = "Students coded as White as compared to those coded as Hispanic/Latino", 
       caption = paste("SCHOOLYEAR", "DISTRICT", "Oregon", sep = ", ")) +
  geom_hline(yintercept = 0, size = 1.5, color = "#92D5CA", alpha = 0.8) + 
  scale_fill_viridis_c(limits = c(-1.5, 1.5)) + 
  theme(legend.position = "bottom")
```

